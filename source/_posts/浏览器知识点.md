---
title: 浏览器知识点
date: 2023-08-14 10:12:26
tags:
---
## requestIdleCallback和requestAnimationFrame的异同  
区别  
- `requestAnimationFrame`每次渲染完执行，优先级高
- `requestIdleCallback`空闲时才执行，优先级低[01-浏览器原理.md](..%2F..%2F..%2F..%2Fnote%2Fmy-web-note%2F%E4%AF%C0%C0%C6%F7%2F01-%E4%AF%C0%C0%C6%F7%D4%AD%C0%ED.md)

共同点
- 都是宏任务，需要等DOM渲染完后再执行

## 从输入url到看到界面的过程

1. 检查缓存
   ```
   如果本地浏览器有本地的静态资源缓存，且未过期，则直接从缓存中读取，而不会发送网络请求。
   ```
2. DNS解析
    ```
    将输入的url对应的域名解析成ip，DNS解析过程根据
        本机的hosts文件
        本地DNS缓存
        本地域名服务器
    的优先级解析域名。在域名解析过程还可能涉及和顶级域名服务器的交互。
    ```

3. 发送HTTP请求

    ```
    建立TCP连接，如果是HTTPS还需要建立TLS连接，然后发送HTTP请求，
    并接收相应，如果相应状态码为301/302还需要进行重定向。
    ```

4. 将响应数据提交给渲染进程处理

    ```
    渲染进程解析HTML，在这个过程中，会提前解析外链（link和script）并提前下载。
    ```

5. 构建DOM

    ```
    将HTML数据转换为DOM。
    ```

6. 样式计算

    ```
    将CSS转换为CSSOM（document.styleSheets），并使用CSSOM，
    根据继承规则和层叠规则， 计算每个DOM节点的具体样式，得到ComputedStyle树。
    ```

7. 布局

    ```
    根据DOM树和ComputedStyle，计算所有可见元素的坐标，生成一个新的树：布局树。
    ```

8. 分层
    ```
    根据布局树生成不同的图层，得到分层树(LayerTree)。
    ```
9.  绘制
    ```
    对每个层生成绘制指令。然后渲染引擎将绘制指令提交给合成线程处理。
    ```
10. 分块
    ```
    合成线程会先将每个图层分块(tile)，优先渲染视口附近的块。合成线程把tile提供给栅格化线程。
    ```

11. 栅格化
     ```
     栅格化线程把每个块转成位图，并写道显存中。一旦所有图块都被栅格化，
    合成线程就会生成一个绘制图块的命令——"DrawQuad"，然后将该命令提交给浏览器进程。
    "DrawQuad"是一系列的指令，这些指令引用了显存中的tile位图。
     ```
12. 合成
     ```
     浏览器进程接收到DrawQuad，并用指令将tile合成完整的帧，
    然后调用GPU进程将合成后的帧绘制到屏幕上。
     ```  
    
# 浏览器缓存
## 1.缓存位置
从缓存位置上来分有四种，优先级从上到下
1. `Service Worker`: 持续性缓存
2. `Memory Cache`：读取速度快，缓存持续性短（随着进程释放），可使用空间小
3. `Disk Cache`：读取速度慢，胜在容量和时效，根据相应头来判断缓存哪些资源等
4. `Push Cache`：HTTP/2中的内容，时间短，只在会话中存在

如果上面四个缓存都没有命中，才会去发网络请求
## 2.缓存策略
缓存策略可以分为**强缓存**和**协商缓存**
### 强缓存
强缓存可以通过设置两种`HTTP Header`来实现，包括：
- Expires  
  为资源设置一个过期时间，如果资源过期了则需要重新请求。  
  **缺陷：**  
  修改本地时间可能会使缓存失效
- Cache-Control  
  优先级高于Expires。可以在请求头或响应头中设置，并且可以组合使用多种指令。  
  **可以设置**  
  缓存失效时间、客户端和代理服务器都能缓存等

强缓存在缓存期间不需要请求，`state code`为**200**
### 协商缓存
如果缓存过期了，就**需要发起请求验证资源是否有更新**。协商缓存可以通过设置两种头实现：  
`Last-Modified`和`ETag`  
当浏览器发起请求验证资源时，如果资源没有做改变，那么服务器就会返回304状态码，并且更新浏览器缓存有效期。